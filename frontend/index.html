<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Terraform LogViewer</title>
  <link rel="stylesheet" href="/styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <h1>Terraform LogViewer</h1>
  </header>
  <main>
    <section id="upload-section">
      <h2>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –ª–æ–≥–æ–≤ (JSONL)</h2>
      <form id="upload-form">
        <input type="file" id="file-input" accept=".log,.txt,.jsonl,.json" required />
        <button type="submit" class="success">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </form>
      <div id="upload-result"></div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button id="btn-import" class="secondary">üìÅ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥</button>
        <small>–ö–∞—Ç–∞–ª–æ–≥: –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è IMPORT_DIR –≤ API (—Å–º. docker-compose)</small>
        <label>–ú–∞—Å–∫–∞ <input id="import-pattern" placeholder="*.jsonl" style="width:140px"/> 
          <span style="color: #9ca3af; font-size: 12px; cursor: help;" title="–ü—Ä–∏–º–µ—Ä—ã –º–∞—Å–æ–∫:
* - –≤—Å–µ —Ñ–∞–π–ª—ã
*.json - —Ñ–∞–π–ª—ã —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .json
*.log - —Ñ–∞–π–ª—ã —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .log
test*.jsonl - —Ñ–∞–π–ª—ã –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å 'test' –∏ –∏–º–µ—é—â–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ .jsonl
*plan* - —Ñ–∞–π–ª—ã —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ 'plan' –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏

–ú–∞—Å–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ glob-–ø–∞—Ç—Ç–µ—Ä–Ω—ã Unix.">‚ÑπÔ∏è</span>
        </label>
        <button id="btn-hide-report" class="secondary" style="display:none">‚ùå –°–∫—Ä—ã—Ç—å –æ—Ç—á—ë—Ç</button>
      </div>
      <div id="import-progress" style="margin-top:6px;display:none">
        <div style="height:8px;background:#0b1220;border:1px solid #374151;border-radius:8px;overflow:hidden">
          <div id="import-bar" style="height:100%;width:0;background:linear-gradient(90deg,#3b82f6,#06b6d4)"></div>
        </div>
        <div id="import-status" style="margin-top:4px;color:#9ca3af"></div>
        <div id="import-report" style="margin-top:6px;font-size:12px"></div>
      </div>
    </section>

    <section id="runs-section">
      <h2>–ó–∞–ø—É—Å–∫–∏</h2>
<div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
        <button id="refresh-runs" class="success">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button id="clear-history" class="danger">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        <label style="margin-left: 8px;">
          <input type="checkbox" id="only-pinned-files" /> –¢–æ–ª—å–∫–æ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        </label>
        
        <!-- Pagination controls for runs -->
        <div id="runs-pagination" style="display: flex; gap: 4px; align-items: center; margin-left: auto;">
          <span id="runs-info" style="color: #9ca3af; font-size: 12px; margin-right: 8px;">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1</span>
          <button id="runs-prev" class="secondary" style="padding: 4px 8px; font-size: 12px;">¬´ –ù–∞–∑–∞–¥</button>
          <button id="runs-next" class="secondary" style="padding: 4px 8px; font-size: 12px;">–í–ø–µ—Ä–µ–¥ ¬ª</button>
          <label style="margin-left: 8px; color: #9ca3af; font-size: 12px;">
            –ü–æ–∫–∞–∑–∞—Ç—å:
            <select id="runs-page-size-top" style="margin-left: 4px; background: #1f2937; color: #e5e7eb; border: 1px solid #374151; padding: 2px 4px;">
              <option value="10">10</option>
              <option value="20" selected>20</option>
              <option value="50">50</option>
            </select>
          </label>
        </div>
      </div>
      <ul id="runs-list"></ul>
    </section>

    <section id="filters-section">
      <h2>–§–∏–ª—å—Ç—Ä—ã</h2>
      <div class="filters">
        <label>tf_req_id <input id="f-req" /></label>
        <label>resource_type <input id="f-type" /></label>
        <label>level
          <select id="f-level">
            <option value="">‚Äî</option>
            <option>error</option>
            <option>warn</option>
            <option>info</option>
            <option>debug</option>
          </select>
        </label>
        <label>status
          <select id="f-status">
            <option value="">‚Äî</option>
            <option value="error">error</option>
            <option value="malformed">malformed</option>
            <option value="ok">ok</option>
          </select>
        </label>
        <label>–ü–æ–∏—Å–∫ <input id="f-search" placeholder="—Ç–µ–∫—Å—Ç –∏–ª–∏ JSON" /></label>
        <label>–û—Ç <input id="f-from" type="datetime-local" /></label>
        <label>–î–æ <input id="f-to" type="datetime-local" /></label>
        <button id="apply-filters">üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
    </section>

    <section id="logs-section">
      <h2>–õ–æ–≥–∏ <span id="pinned-groups-indicator" style="font-size: 12px; color: #10b981; margin-left: 8px; font-weight: normal;"></span></h2>
      <div class="pager">
        <button id="prev-page">¬´</button>
        <span id="page-info"></span>
        <button id="next-page">¬ª</button>
        <label style="margin-left:8px">–†–∞–∑–º–µ—Ä
          <select id="page-size">
            <option>10</option>
            <option>20</option>
            <option selected>50</option>
            <option>100</option>
          </select>
        </label>
        <label style="margin-left:8px">
          <input type="checkbox" id="include-pairs" /> –°—Ü–µ–ø–ª—è—Ç—å –ø–∞—Ä—ã
        </label>
        <label style="margin-left:8px">–ü–æ –∫–ª—é—á—É
          <select id="pair-by">
            <option value="tf_req_id" selected>tf_req_id</option>
            <option value="resource">resource</option>
            <option value="phase">phase</option>
          </select>
        </label>
        <label style="margin-left:8px">
          <input type="checkbox" id="group-rows" checked /> –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å
        </label>
        <button id="collapse-all" class="secondary" title="–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ">üì• –°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
        <button id="expand-all" class="secondary" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ">üì§ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
        <button id="select-display-groups" class="secondary" title="–í—ã–±—Ä–∞—Ç—å –≥—Ä—É–ø–ø—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è">üîç –í—ã–±–æ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</button>
        <button id="select-groups" class="primary" title="–í—ã–±—Ä–∞—Ç—å –≥—Ä—É–ø–ø—ã –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞">üéØ –í—ã–±–æ—Ä –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞</button>
        <label style="margin-left:8px">
          <input type="checkbox" id="only-pinned" /> –¢–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã
        </label>
        <button id="export-jsonl" class="secondary">üíæ –≠–∫—Å–ø–æ—Ä—Ç JSONL</button>
      </div>
      <div class="table-container">
        <table id="logs-table">
          <thead>
            <tr>
              <th>ts</th>
              <th>level</th>
              <th class="hide-mobile">phase</th>
              <th>req_id</th>
              <th class="hide-mobile">type</th>
              <th class="hide-mobile">name</th>
              <th>message</th>
              <th>json</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="timeline-section">
      <h2>–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è (–ì–∞–Ω—Ç—Ç)</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
        <label>–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞
          <select id="timeline-group">
            <option value="tf_req_id">tf_req_id</option>
            <option value="resource">resource</option>
            <option value="phase">phase</option>
          </select>
        </label>
        <button id="export-timeline-json" class="secondary">üíæ –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        <button id="export-timeline-csv" class="secondary">üìä –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
        <button id="export-timeline-image" class="secondary">üñºÔ∏è –°–∫–∞—á–∞—Ç—å PNG</button>
      </div>
      <div id="timeline"></div>
    </section>
  </main>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø -->
  <div id="group-selection-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üéØ –í—ã–±–æ—Ä –≥—Ä—É–ø–ø –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞</h3>
        <button id="close-group-modal" class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="group-selection-controls">
          <div class="group-type-selector">
            <label>–¢–∏–ø –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏:
              <select id="modal-pair-by">
                <option value="tf_req_id">tf_req_id</option>
                <option value="resource">resource</option>
                <option value="phase">phase</option>
              </select>
            </label>
            <button id="load-groups" class="primary">üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä—É–ø–ø—ã</button>
          </div>
          <div class="group-selection-actions">
            <button id="select-all-groups" class="secondary">‚úì –í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
            <button id="deselect-all-groups" class="secondary">‚úó –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
            <span id="selected-count">0 –≤—ã–±—Ä–∞–Ω–æ</span>
          </div>
        </div>
        <div id="groups-loading" style="display: none; text-align: center; padding: 20px;">
          üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø...
        </div>
        <div id="groups-list" class="groups-list"></div>
      </div>
      <div class="modal-footer">
        <button id="export-selected-groups" class="warning">üìå –≠–∫—Å–ø–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</button>
        <button id="cancel-group-selection" class="secondary">‚ùå –û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
  <div id="display-group-selection-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üîç –í—ã–±–æ—Ä –≥—Ä—É–ø–ø –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
        <button id="close-display-group-modal" class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="group-selection-controls">
          <div class="group-type-selector">
            <label>–¢–∏–ø –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏:
              <select id="display-modal-pair-by">
                <option value="tf_req_id">tf_req_id</option>
                <option value="resource">resource</option>
                <option value="phase">phase</option>
              </select>
            </label>
            <button id="load-display-groups" class="primary">üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä—É–ø–ø—ã</button>
          </div>
          <div class="group-selection-actions">
            <button id="select-all-display-groups" class="secondary">‚úì –í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
            <button id="deselect-all-display-groups" class="secondary">‚úó –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
            <span id="display-selected-count">0 –≤—ã–±—Ä–∞–Ω–æ</span>
          </div>
        </div>
        <div id="display-groups-loading" style="display: none; text-align: center; padding: 20px;">
          üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø...
        </div>
        <div id="display-groups-list" class="groups-list"></div>
      </div>
      <div class="modal-footer">
        <button id="apply-display-group-selection" class="primary">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏ –ø–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏</button>
        <button id="cancel-display-group-selection" class="secondary">‚ùå –û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <script src="/app.js"></script>
  <script>
    // –£–∫–∞–∂–∏—Ç–µ URL API –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è)
    // Configure API base URL - works in both Docker and local development
    window.API_BASE = window.API_BASE || 
      (window.location.hostname === 'localhost' && window.location.port === '8080' 
        ? 'http://localhost:8000/api'  // Frontend on 8080, API on 8000
        : '/api');  // Same-origin (integrated server)
  </script>
</body>
</html>
